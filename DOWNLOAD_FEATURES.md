# 下载功能更新说明

## 更新内容

本次更新对 LibreTV 的视频下载功能进行了全面改进，解决了以下问题：

### 1. 完整视频下载（MP4 格式）

**问题**：之前下载的文件是 `.ts` 格式，虽然已经合并了所有片段，但格式不够通用。

**解决方案**：
- 修改了 `m3u8-downloader.js` 中的 `mergeSegments` 函数，将 Blob 类型从 `video/mp2t` 改为 `video/mp4`
- 修改了 `player.js` 中的文件名生成逻辑，将扩展名从 `.ts` 改为 `.mp4`
- 下载的视频现在可以在所有主流播放器中正常播放

**修改文件**：
- `js/m3u8-downloader.js` (第 197 行)
- `js/player.js` (第 105 行)

### 2. 后台下载功能

**问题**：之前下载时会弹出模态框占用主页面，用户无法继续浏览或选择其他视频。

**解决方案**：
- 创建了全新的下载管理器 (`download-manager.js`)
- 实现了独立的下载队列系统
- 添加了浮动按钮和可折叠的下载面板
- 支持同时管理多个下载任务
- 下载进度实时显示，不阻塞主界面

**新增文件**：
- `js/download-manager.js` - 下载管理器核心逻辑

**功能特性**：
- 最多支持 3 个并发下载任务
- 自动队列管理，超过并发数的任务自动排队
- 下载历史记录保存（最多 100 条）
- 支持暂停、重试、删除下载任务
- 清除已完成任务功能

### 3. 批量下载功能

**问题**：之前只能单集下载，对于连续剧需要重复操作多次。

**解决方案**：
- 创建了批量下载模块 (`batch-download.js`)
- 添加了批量下载模式切换按钮
- 支持多种选择方式：全选、取消全选、范围选择
- 选中的集数会高亮显示，带有勾选标记

**新增文件**：
- `js/batch-download.js` - 批量下载逻辑

**使用方法**：
1. 点击播放器页面的"批量下载"按钮进入批量模式
2. 点击想要下载的集数进行选择（可多选）
3. 使用"全选"、"取消全选"或"选择范围"快速操作
4. 点击"开始下载"将所有选中的集数加入下载队列
5. 点击"取消"退出批量模式

### 4. 本地路径选择

**问题**：之前无法自定义下载路径，所有文件都保存到浏览器默认下载目录。

**解决方案**：
- 在下载设置界面添加了"本地下载路径"选项
- 使用 File System Access API 实现目录选择
- 目录句柄保存到 IndexedDB，下次使用时自动加载
- 如果浏览器不支持，会显示提示信息并回退到默认下载方式

**修改文件**：
- `js/download-settings-ui.js` - 添加路径选择 UI 和逻辑
- `js/m3u8-downloader.js` - 支持自定义目录保存

**浏览器兼容性**：
- Chrome/Edge 86+
- Opera 72+
- Safari 不支持（会回退到默认下载）
- Firefox 不支持（会回退到默认下载）

**使用方法**：
1. 点击下载设置按钮
2. 在"本地下载路径"部分点击"选择目录"
3. 在弹出的文件选择器中选择想要保存视频的文件夹
4. 确认后，所有下载将自动保存到该目录

## 文件结构

```
js/
├── m3u8-downloader.js      # M3U8 下载核心（已修改）
├── download-manager.js     # 下载管理器（新增）
├── batch-download.js       # 批量下载（新增）
├── download-settings.js    # 下载设置数据（已存在）
├── download-settings-ui.js # 下载设置界面（已修改）
└── player.js               # 播放器主逻辑（已修改）

player.html                 # 播放器页面（已修改，添加批量下载按钮和脚本引用）
```

## 技术细节

### 下载管理器架构

```javascript
DownloadManager
├── downloads[]           // 下载任务数组
├── activeDownloads      // 当前活动下载数
├── maxConcurrentDownloads // 最大并发数（3）
├── addDownload()        // 添加单个任务
├── addBatchDownloads()  // 批量添加任务
├── processQueue()       // 处理下载队列
├── startDownload()      // 开始单个下载
├── retryDownload()      // 重试失败任务
└── updateUI()           // 更新界面显示
```

### 批量下载流程

```
用户点击批量下载按钮
    ↓
进入批量模式，显示操作面板
    ↓
用户选择集数（点击/全选/范围选择）
    ↓
点击"开始下载"
    ↓
构建下载任务列表
    ↓
调用 downloadManager.addBatchDownloads()
    ↓
任务加入队列，自动开始下载
    ↓
退出批量模式
```

### IndexedDB 存储结构

```javascript
Database: LibreTV_DownloadSettings
└── ObjectStore: directoryHandles
    └── Key: 'downloadDirectory'
        └── Value: FileSystemDirectoryHandle
```

## 注意事项

1. **浏览器权限**：使用自定义下载路径时，浏览器会请求文件系统访问权限，用户需要允许。

2. **并发限制**：为避免服务器压力和浏览器性能问题，下载管理器限制了最大并发数为 3。

3. **存储空间**：批量下载大量视频时，请确保有足够的磁盘空间。

4. **网络稳定性**：下载过程中如果网络中断，可以使用"重试"功能继续下载。

5. **文件格式**：虽然保存为 `.mp4` 扩展名，但实际上是 MPEG-TS 容器格式的数据，大多数播放器可以正常播放。如需真正的 MP4 格式，可能需要后续使用 FFmpeg 等工具转换。

## 兼容性

- ✅ Chrome 86+
- ✅ Edge 86+
- ✅ Opera 72+
- ⚠️ Safari（部分功能不支持）
- ⚠️ Firefox（部分功能不支持）

## 未来改进方向

1. 添加下载速度限制选项
2. 支持断点续传
3. 添加下载完成通知
4. 支持导出/导入下载列表
5. 真正的 MP4 格式转换（需要服务端支持或 WebAssembly FFmpeg）
